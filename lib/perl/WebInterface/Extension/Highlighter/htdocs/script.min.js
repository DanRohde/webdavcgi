(function(a){a(document).ready(function(){a(".action.markcolorpicker").iris({hide:true,palettes:true,color:"#ff0000",change:function(m,l){var k=a(this);if(k.data("quiet")){k.data("quiet",false);return}j(ToolBox.getSelectedRows(k),k.data("style"),l.color.toString());window.clearTimeout(k.data("timeout"));k.data("timeout",window.setTimeout(function(){i(ToolBox.getSelectedRows(k),k.data("style"),l.color.toString());g(ToolBox.getSelectedFiles(k),k.data("style"),l.color.toString())},2000))}});a(".action.mark").on("click",function(n){a.MyPreventDefault(n);var k=a(this);var m=ToolBox.getSelectedFiles(this);var p=ToolBox.getSelectedRows(this);var l=k.data("style");var o=k.data("value");j(p,l,o);i(p,l,o);g(m,l,o)});a(".action.removemarks").on("click",function(o){a.MyPreventDefault(o);var k=a(this);var n=ToolBox.getSelectedFiles(this);var p=ToolBox.getSelectedRows(this);var m=k.data("styles").split(",");for(var l=0;l<m.length;l++){j(p,m[l],"");h(p,m[l])}a.MyPost(window.location.pathname,{action:"removemarks",styles:k.data("styles"),files:n},b,true)});a(".action.markcolorpicker").on("click",function(k){a.MyPreventDefault(k);a(this).iris("toggle")});a(".action.replacemarks").on("click",function(p){a.MyPreventDefault(p);var l=a(this);var o=ToolBox.getSelectedFiles(this);var r=ToolBox.getSelectedRows(this);var q=a(window).data("highlighter.transfer");if(q){a(".action.replacemarks").removeClass("active");var n=l.data("styles").split(",");for(var m=0;m<n.length;m++){j(r,n[m],"");h(r,n[m])}for(var k in q){i(r,k,q[k]);j(r,k,q[k])}a.MyPost(window.location.pathname,{action:"replacemarks",files:o,style:JSON.stringify(q)},b,true);a(window).removeData("highlighter.transfer")}else{a(".action.replacemarks").addClass("active");a(window).data("highlighter.transfer",d(r))}});a(".action.savemarksaspreset").on("click",function(m){a.MyPreventDefault(m);var k=a(this);var n=ToolBox.getSelectedRows(this);var l=window.prompt(k.data("name"));if(l&&l.trim()!=""){a.MyPost(window.location.pathname,{action:"savemarksaspreset",name:l,data:JSON.stringify(d(n))},function(o){b(o);e()},true)}});c();a("#flt").on("fileListChanged",f);a("#foldertree").on("foldertreeChanged",f);f();a("#flt").on("popupmenu",function(k,l){if(a(l).hasClass("highlighter-highlighted")){a(".action.markcolorpicker").each(function(o,n){var m=a(a(l).data("highlighter")).attr(a(n).data("style"));if(m){a(n).data("quiet",true);a(n).iris("option","color",m)}})}});function c(){a(".action.markwithpreset").on("click",function(o){a.MyPreventDefault(o);var k=a(this);var p=ToolBox.getSelectedRows(this);var n=a(".highlighter-popup .removemarks").last().data("styles").split(",");for(var l=0;l<n.length;l++){j(p,n[l],"");h(p,n[l])}n=k.data("style");for(var m in n){i(p,m,n[m]);j(p,m,n[m])}a.MyPost(window.location.pathname,{action:"replacemarks",style:JSON.stringify(k.data("style")),files:ToolBox.getSelectedFiles(this)},b,true)});a(".action.managepresets").on("click",function(l){a.MyPreventDefault(l);var t=a(this);var o=a(t.data("template"));var k=a("#highlighter-preset-manager-preset-template",o).html();var n=t.data("presets");var q=Object.keys(n).sort();for(var m=0;m<q.length;m++){var r=q[m];var s=n[r];var p=a(k);a(".highlighter-preset-entry-name",p).text(r).attr("title",r+": "+s).css(JSON.parse(s));a(".highlighter-preset-entry-delete",p).attr("data-preset",r).on("click",function(w){a.MyPreventDefault(w);var u=a(this);var v=u.data("preset");ToolBox.confirmDialog(u.data("confirm").replace("%s",v),{confirm:function(){u.parent(".highlighter-preset-entry").remove();a.MyPost(window.location.href,{action:"deletepreset",preset:v},function(x){b(x);if(x.error){window.location.reload(true)}else{o.data("changes",true)}})}})});a("#highlighter-preset-manager-entries",o).append(p)}o.dialog({modal:true,width:"auto",dialogClass:"managepresets",closeText:a("#close").html(),close:function(){if(o.data("changes")){e()}}});o.MyTooltip(500)})}function e(){a.MyPost(window.location.pathname,{},function(k){a(".toolbar .highlighter.subpreset").html(a(".toolbar .highlighter.subpreset",k).html());a("#popupmenu .highlighter.subpreset").html(a("#popupmenu .highlighter.subpreset",k).html());c()},true)}function d(l){var k={};l.filter(".highlighter-highlighted").each(function(o,n){var p=a(n);var q=p.data("highlighter");for(var m in q){k[m]=q[m]}});return k}function j(m,k,l){if(m.hasClass("mft-node")){m.find(".mft-node-label:first").css(k,l);return m}if(k=="background"||k.match(/^border/)!=null){m.css(k,l)}else{if(k=="transform"){a("td",m).css(k,l)}else{a("td",m.css(k,l)).css(k,l)}}return m}function f(){a(".highlighter-highlighted").each(function(n,m){var l=a(m);var o=l.data("highlighter");for(var k in o){j(l,k,o[k])}})}function b(k){ToolBox.handleJSONResponse(k);if(k.error){ToolBox.updateFileList()}}function h(l,k){var m=l.data("highlighter");if(!m){return false}delete m[k];l.data("highlighter",m);return true}function i(m,l,k){var n=m.data("highlighter");if(!n){n={}}n[l]=k;m.data("highlighter",n).addClass("highlighter-highlighted")}function g(l,k,m){a.MyPost(window.location.pathname,{action:"mark",style:k,value:m,files:l},b,true)}})}(jQuery));