(function(a){a(document).ready(function(){a(".action.markcolorpicker").iris({hide:true,palettes:true,color:"#ff0000",change:function(n,m){var l=a(this);if(l.data("quiet")){l.data("quiet",false);return}k(ToolBox.getSelectedRows(l),l.data("style"),m.color.toString());window.clearTimeout(l.data("timeout"));l.data("timeout",window.setTimeout(function(){i(ToolBox.getSelectedRows(l),l.data("style"),m.color.toString());h(ToolBox.getSelectedFiles(l),l.data("style"),m.color.toString())},2000))}});a(".action.mark").on("click",function(o){a.MyPreventDefault(o);var l=a(this);var n=ToolBox.getSelectedFiles(this);var q=ToolBox.getSelectedRows(this);var m=l.data("style");var p=l.data("value");k(q,m,p);i(q,m,p);h(n,m,p)});a(".action.removemarks").on("click",function(p){a.MyPreventDefault(p);var l=a(this);var o=ToolBox.getSelectedFiles(this);var q=ToolBox.getSelectedRows(this);var n=l.data("styles").split(",");for(var m=0;m<n.length;m++){k(q,n[m],"");j(q,n[m])}a.MyPost(window.location.pathname,{action:"removemarks",styles:l.data("styles"),files:o},b,true)});a(".action.markcolorpicker").on("click",function(l){a.MyPreventDefault(l);a(this).iris("toggle")});a(".action.replacemarks").on("click",function(q){a.MyPreventDefault(q);var m=a(this);var p=ToolBox.getSelectedFiles(this);var s=ToolBox.getSelectedRows(this);var r=a(window).data("highlighter.transfer");if(r){a(".action.replacemarks").removeClass("active");var o=m.data("styles").split(",");for(var n=0;n<o.length;n++){k(s,o[n],"");j(s,o[n])}for(var l in r){i(s,l,r[l]);k(s,l,r[l])}a.MyPost(window.location.pathname,{action:"replacemarks",files:p,style:JSON.stringify(r)},b,true);a(window).removeData("highlighter.transfer")}else{a(".action.replacemarks").addClass("active");a(window).data("highlighter.transfer",e(s))}});a(".action.savemarksaspreset").on("click",function(n){a.MyPreventDefault(n);var l=a(this);var o=ToolBox.getSelectedRows(this);var m=window.prompt(l.data("name"));if(m&&m.trim()!=""){a.MyPost(window.location.pathname,{action:"savemarksaspreset",name:m,data:JSON.stringify(e(o))},function(p){b(p);f()},true)}});d();a("#flt").on("fileListChanged",g);a("#foldertree").on("foldertreeChanged",g);g();a("#flt").on("popupmenu",function(l,m){if(a(m).hasClass("highlighter-highlighted")){a(".action.markcolorpicker").each(function(p,o){var n=a(a(m).data("highlighter")).attr(a(o).data("style"));if(n){a(o).data("quiet",true);a(o).iris("option","color",n)}})}});function d(){a(".action.markwithpreset").on("click",function(p){a.MyPreventDefault(p);var l=a(this);var q=ToolBox.getSelectedRows(this);var o=a(".highlighter-popup .removemarks").last().data("styles").split(",");for(var m=0;m<o.length;m++){k(q,o[m],"");j(q,o[m])}o=l.data("style");for(var n in o){i(q,n,o[n]);k(q,n,o[n])}a.MyPost(window.location.pathname,{action:"replacemarks",style:JSON.stringify(l.data("style")),files:ToolBox.getSelectedFiles(this)},b,true)});a(".action.managepresets").on("click",function(m){a.MyPreventDefault(m);var u=a(this);var p=a(u.data("template"));var l=a("#highlighter-preset-manager-preset-template",p).html();var o=u.data("presets");var r=Object.keys(o).sort();for(var n=0;n<r.length;n++){var s=r[n];var t=o[s];var q=a(l);a(".highlighter-preset-entry-name",q).text(s).attr("title",s+": "+t).css(JSON.parse(t));a(".highlighter-preset-entry-delete",q).attr("data-preset",s).on("click",function(x){a.MyPreventDefault(x);var v=a(this);var w=v.data("preset");ToolBox.confirmDialog(v.data("confirm").replace("%s",w),{confirm:function(){v.parent(".highlighter-preset-entry").remove();a.MyPost(window.location.href,{action:"deletepreset",preset:w},function(y){b(y);if(y.error){window.location.reload(true)}else{p.data("changes",true)}})}})});a("#highlighter-preset-manager-entries",p).append(q)}p.dialog({modal:true,width:"auto",dialogClass:"managepresets",closeText:a("#close").html(),close:function(){if(p.data("changes")){f()}}});p.MyTooltip(500)})}function f(){a.MyPost(window.location.pathname,{},function(l){a(".toolbar .highlighter.subpreset").html(a(".toolbar .highlighter.subpreset",l).html());a("#popupmenu .highlighter.subpreset").html(a("#popupmenu .highlighter.subpreset",l).html());d()},true)}function e(m){var l={};m.filter(".highlighter-highlighted").each(function(p,o){var q=a(o);var r=q.data("highlighter");for(var n in r){l[n]=r[n]}});return l}function k(o,m,n){var l=WebDAVCGI.foldertree.getFolderTreeNodesForRows(o);c(o,m,n);c(l,m,n)}function c(n,l,m){if(n.hasClass("mft-node")){n.find(".mft-node-label:first").css(l,m);return n}if(l=="background"||l.match(/^border/)!=null){n.css(l,m)}else{if(l=="transform"){a("td",n).css(l,m)}else{a("td",n.css(l,m)).css(l,m)}}return n}function g(){a(".highlighter-highlighted").each(function(o,n){var m=a(n);var p=m.data("highlighter");for(var l in p){c(m,l,p[l])}})}function b(l){ToolBox.handleJSONResponse(l);if(l.error){ToolBox.updateFileList()}}function j(n,m){var o=n.data("highlighter");if(!o){return false}delete o[m];var l=WebDAVCGI.foldertree.getFolderTreeNodesForRows(n);n.data("highlighter",o);l.data("highlighter",o);return true}function i(o,n,m){var p=o.data("highlighter");if(!p){p={}}p[n]=m;var l=WebDAVCGI.foldertree.getFolderTreeNodesForRows(o);o.data("highlighter",p).addClass("highlighter-highlighted");l.data("highlighter",p).addClass("highlighter-highlighted")}function h(m,l,n){a.MyPost(window.location.pathname,{action:"mark",style:l,value:n,files:m},b,true)}})}(jQuery));