(function(e){e(document).ready(function(){function t(){e(".action.markwithpreset").off("click.highlighter").on("click.highlighter",function(t){e.MyPreventDefault(t);var n=e(this),r=ToolBox.getSelectedRows(this),s=e(".highlighter-popup .removemarks").last().data("styles").split(",");for(var o=0;o<s.length;o++)i(r,s[o],""),a(r,s[o]);s=n.data("style");for(var l in s)f(r,l,s[l]),i(r,l,s[l]);e.MyPost(window.location.pathname,{action:"replacemarks",style:JSON.stringify(n.data("style")),files:ToolBox.getSelectedFiles(this)},u,!0)}),e(".action.managepresets").off("click.highlighter").on("click.highlighter",function(t){e.MyPreventDefault(t);var r=e(this),i=e(r.data("template")),s=e("#highlighter-preset-manager-preset-template",i).html(),o=r.data("presets"),a=Object.keys(o).sort();for(var f=0;f<a.length;f++){var l=a[f],c=o[l],h=e(s);e(".highlighter-preset-entry-name",h).text(l).attr("title",l+": "+c).css(JSON.parse(c)),e(".highlighter-preset-entry-delete",h).attr("data-preset",l).on("click",function(t){e.MyPreventDefault(t);var n=e(this),r=n.data("preset");ToolBox.confirmDialog(n.data("confirm").replace("%s",r),{confirm:function(){n.parent(".highlighter-preset-entry").remove(),e.MyPost(window.location.href,{action:"deletepreset",preset:r},function(e){u(e),e.error?window.location.reload(!0):i.data("changes",!0)})}})}),e("#highlighter-preset-manager-entries",i).append(h)}i.dialog({modal:!0,width:"auto",dialogClass:"managepresets",closeText:e("#close").html(),close:function(){i.data("changes")&&n()}}),i.MyTooltip(500)})}function n(){e.MyPost(window.location.pathname,{},function(n){e(".toolbar .highlighter.subpreset").html(e(".toolbar .highlighter.subpreset",n).html()),e("#popupmenu .highlighter.subpreset").html(e("#popupmenu .highlighter.subpreset",n).html()),t()},!0)}function r(t){var n={};return t.filter(".highlighter-highlighted").each(function(t,r){var i=e(r),s=i.data("highlighter");for(var o in s)n[o]=s[o]}),n}function i(e,t,n){var r=WebDAVCGI.foldertree.getFolderTreeNodesForRows(e);s(e,t,n),s(r,t,n)}function s(t,n,r){return t.hasClass("mft-node")?(t.find(".mft-node-label:first").css(n,r),t):(n=="background"||n.match(/^border/)!=null?t.css(n,r):n=="transform"?e("td",t).css(n,r):e("td",t.css(n,r)).css(n,r),t)}function o(){e(".highlighter-highlighted").each(function(t,n){var r=e(n),i=r.data("highlighter");for(var o in i)s(r,o,i[o])})}function u(e){ToolBox.handleJSONResponse(e),e.error&&ToolBox.updateFileList()}function a(e,t){var n=e.data("highlighter");if(!n)return!1;delete n[t];var r=WebDAVCGI.foldertree.getFolderTreeNodesForRows(e);return e.data("highlighter",n),r.data("highlighter",n),!0}function f(e,t,n){var r=e.data("highlighter");r||(r={}),r[t]=n;var i=WebDAVCGI.foldertree.getFolderTreeNodesForRows(e);e.data("highlighter",r).addClass("highlighter-highlighted"),i.data("highlighter",r).addClass("highlighter-highlighted")}function l(t,n,r){e.MyPost(window.location.pathname,{action:"mark",style:n,value:r,files:t},u,!0)}e(".action.markcolorpicker").iris({hide:!0,palettes:!0,color:"#ff0000",change:function(t,n){var r=e(this);if(r.data("quiet")){r.data("quiet",!1);return}i(ToolBox.getSelectedRows(r),r.data("style"),n.color.toString()),window.clearTimeout(r.data("timeout")),r.data("timeout",window.setTimeout(function(){f(ToolBox.getSelectedRows(r),r.data("style"),n.color.toString()),l(ToolBox.getSelectedFiles(r),r.data("style"),n.color.toString())},2e3))}}),e(".action.mark").on("click",function(t){e.MyPreventDefault(t);var n=e(this),r=ToolBox.getSelectedFiles(this),s=ToolBox.getSelectedRows(this),o=n.data("style"),u=n.data("value");i(s,o,u),f(s,o,u),l(r,o,u)}),e(".action.removemarks").on("click",function(t){e.MyPreventDefault(t);var n=e(this),r=ToolBox.getSelectedFiles(this),s=ToolBox.getSelectedRows(this),o=n.data("styles").split(",");for(var f=0;f<o.length;f++)i(s,o[f],""),a(s,o[f]);e.MyPost(window.location.pathname,{action:"removemarks",styles:n.data("styles"),files:r},u,!0)}),e(".action.markcolorpicker").on("click",function(t){e.MyPreventDefault(t),e(this).iris("toggle")}),e(".action.replacemarks").on("click",function(t){e.MyPreventDefault(t);var n=e(this),s=ToolBox.getSelectedFiles(this),o=ToolBox.getSelectedRows(this),l=e(window).data("highlighter.transfer");if(l){e(".action.replacemarks").removeClass("active");var c=n.data("styles").split(",");for(var h=0;h<c.length;h++)i(o,c[h],""),a(o,c[h]);for(var p in l)f(o,p,l[p]),i(o,p,l[p]);e.MyPost(window.location.pathname,{action:"replacemarks",files:s,style:JSON.stringify(l)},u,!0),e(window).removeData("highlighter.transfer")}else e(".action.replacemarks").addClass("active"),e(window).data("highlighter.transfer",r(o))}),e(".action.savemarksaspreset").on("click",function(t){e.MyPreventDefault(t);var i=e(this),s=ToolBox.getSelectedRows(this),o=window.prompt(i.data("name"));o&&o.trim()!=""&&e.MyPost(window.location.pathname,{action:"savemarksaspreset",name:o,data:JSON.stringify(r(s))},function(e){u(e),n()},!0)}),t(),e("#flt").on("fileListChanged",o),e("#foldertree").on("foldertreeChanged",o),o(),e("#flt").on("popupmenu",function(t,n){e(n).hasClass("highlighter-highlighted")&&e(".action.markcolorpicker").each(function(t,r){var i=e(e(n).data("highlighter")).attr(e(r).data("style"));i&&(e(r).data("quiet",!0),e(r).iris("option","color",i))})})})})(jQuery);
