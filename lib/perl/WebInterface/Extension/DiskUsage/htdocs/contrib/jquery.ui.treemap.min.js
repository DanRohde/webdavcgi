var TreemapUtils=TreemapUtils||{};TreemapUtils.sumArray=(function(){function a(d,c){return d+c}return function(b){return b.reduce(a)}}());TreemapUtils.changeColor=function(b,e,h){b=b.replace(/^\s*|\s*$/,"");b=b.replace(/^#?([a-f0-9])([a-f0-9])([a-f0-9])$/i,"#$1$1$2$2$3$3");var g=Math.round(e*256)*(h?-1:1),c=b.match(new RegExp("^rgba?\\(\\s*(\\d|[1-9]\\d|1\\d{2}|2[0-4][0-9]|25[0-5])\\s*,\\s*(\\d|[1-9]\\d|1\\d{2}|2[0-4][0-9]|25[0-5])\\s*,\\s*(\\d|[1-9]\\d|1\\d{2}|2[0-4][0-9]|25[0-5])(?:\\s*,\\s*(0|1|0?\\.\\d+))?\\s*\\)$","i")),f=!!c&&c[4]!==null?c[4]:null,a=!!c?[c[1],c[2],c[3]]:b.replace(/^#?([a-f0-9][a-f0-9])([a-f0-9][a-f0-9])([a-f0-9][a-f0-9])/i,function(j,k,i,l){return parseInt(k,16)+","+parseInt(i,16)+","+parseInt(l,16)}).split(/,/),d;return !!c?"rgb"+(f!==null?"a":"")+"("+Math[h?"max":"min"](parseInt(a[0],10)+g,h?0:255)+", "+Math[h?"max":"min"](parseInt(a[1],10)+g,h?0:255)+", "+Math[h?"max":"min"](parseInt(a[2],10)+g,h?0:255)+(f!==null?", "+f:"")+")":["#",Math[h?"max":"min"](parseInt(a[0],10)+g,h?0:255).toString(16).lpad("0",2),Math[h?"max":"min"](parseInt(a[1],10)+g,h?0:255).toString(16).lpad("0",2),Math[h?"max":"min"](parseInt(a[2],10)+g,h?0:255).toString(16).lpad("0",2)].join("")};TreemapUtils.lighterColor=function(a,b){return TreemapUtils.changeColor(a,b,false)};TreemapUtils.darkerColor=function(a,b){return TreemapUtils.changeColor(a,b,true)};TreemapUtils.rgb2hex=function(a){var b="#"+((a[2]|(a[1]<<8)|(a[0]<<16)).toString(16).lpad("0",6));return b};TreemapUtils.avgRgb=function(a){return Math.floor(TreemapUtils.sumArray(a)/3)};TreemapUtils.hex2rgb=function(a){return a.replace(/^#?([a-f0-9][a-f0-9])([a-f0-9][a-f0-9])([a-f0-9][a-f0-9])/i,function(e,f,d,g){return parseInt(f,16)+","+parseInt(d,16)+","+parseInt(g,16)}).split(/,/)};TreemapUtils.squarify=function(i,h){var j=function(l){this.setX=function(m){l[2]-=m-l[0];l[0]=m};this.setY=function(m){l[3]-=m-l[1];l[1]=m};this.getX=function(){return l[0]};this.getY=function(){return l[1]};this.getW=function(){return l[2]};this.getH=function(){return l[3]};this.getWidth=function(){return Math.min(l[2],l[3])}};var b=function(q,l){var p=Math.max.apply(null,q);var t=Math.min.apply(null,q);var n=TreemapUtils.sumArray(q);var o=n*n;var m=l*l;return Math.max((m*p)/o,o/(m*t))};var e=function(r){var l=d.getX(),s=d.getY(),q=l+d.getW(),p=s+d.getH(),o,n,m;if(d.getW()<d.getH()){o=Math.ceil(TreemapUtils.sumArray(r)/d.getW());if(s+o>=p){o=p-s}for(n=0;n<r.length;n++){m=Math.ceil(r[n]/o);if(l+m>q||n+1===r.length){m=q-l}c.push([l,s,m,o]);l=(l+m)}d.setY(s+o)}else{o=Math.ceil(TreemapUtils.sumArray(r)/d.getH());if(l+o>=q){o=q-l}for(n=0;n<r.length;n++){m=Math.ceil(r[n]/o);if(s+m>p||n+1===r.length){m=p-s}c.push([l,s,o,m]);s=(s+m)}d.setX(l+o)}};var g=function(n){var o=[];o.push(n.shift());if(n.length===0){return o}var m=o.slice();var l=d.getWidth();do{m.push(n[0]);if(b(o,l)>b(m,l)){o=m.slice();n.shift()}else{break}}while(n.length>0);return o};var f=function(l){do{e(g(l))}while(l.length>0)};var k=[];var c=[];var a=[];a=h.map(function(l){return l*(i[2]*i[3])});var d=new j(i.slice());f(a);return c};(function(a){a.widget("ui.treemap",{options:{dimensions:[600,400],colorStops:[{val:0,color:"#08f"},{val:0.5,color:"#03f"},{val:1,color:"#005"}],colorResolution:1024,naColor:"#000",innerNodeHeaderHeight:12,innerNodeHeaderLabeller:function(b,d,c,e){b.rect(d[0],d[1],d[2],d[3]);b.clip();b.fillStyle="#555";b.font="0.625em Verdana, Geneva, sans-serif";b.fillText(e,d[0],d[1]+10)},innerNodeHeaderGradient:function(b,d,c){var e=b.createLinearGradient(d[0],d[1],d[0],d[1]+d[3]);e.addColorStop(0,"#ccc");e.addColorStop(0.5,"#fff");e.addColorStop(0.9,"#fff");e.addColorStop(1,"#555");return e},leafNodeBodyLabeller:function(b,d,c,e){b.rect(d[0],d[1],d[2],d[3]);b.clip();if(TreemapUtils.avgRgb(c)<=200){b.fillStyle="#fff"}else{b.fillStyle="#888"}b.font="0.625em Verdana, Geneva, sans-serif";b.fillText(e,d[0],d[1]+10)},leafNodeBodyGradient:function(d,g,f){var e=Math.min(g[2],g[3])*0.1;var c=Math.max(g[2],g[3]);var b=g[0]+g[2]*0.5;var i=g[1]+g[3]*0.5;var h=d.createRadialGradient(b,i,e,b,i,c);h.addColorStop(0,TreemapUtils.lighterColor(TreemapUtils.rgb2hex(f),0.2));h.addColorStop(1,TreemapUtils.darkerColor(TreemapUtils.rgb2hex(f),0.2));return h},layoutMethod:TreemapUtils.squarify,sizeOption:0,colorOption:0,nodeBorderWidth:0,enableLabels:true,nodeData:{}},_create:function(){},_init:function(){this._refresh()},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments);switch(b){case"dimensions":this.options.dimensions=c;this._refresh();break;case"layoutMethod":this.options.layoutMethod=c;this._refresh();break;case"enableLabels":this.options.enableLabels=c;this._renderNodes();this._renderNodeLabels();break;case"leafNodeBodyGradient":this.options.leafNodeBodyGradient=c;this._renderNodes();this._renderNodeLabels();break;case"colorStops":this.options.colorStops=c;this._refreshColorGradient();this._renderNodes();this._renderNodeLabels();break;case"colorOption":this.options.colorOption=c;this._refreshColorGradient();this._renderNodes();this._renderNodeLabels();break;case"colorOptionAndColorStops":this.options.colorOption=c.colorOption;this.options.colorStops=c.colorStops;this._refreshColorGradient();this._renderNodes();this._renderNodeLabels();break;case"sizeOption":this.options.sizeOption=c;this._refresh();break;case"nodeData":this.options.nodeData=c;this._refresh();break}},_refresh:function(){this._refreshCanvas();this._refreshLayout();this._refreshColorGradient();this._renderNodes();this._renderNodeLabels()},_renderNodes:function(){var b=function(l){var p,k,h,n,o,m;for(o=0;o<l.length;o++){if(f._isRootNode(l[o])===false){p=l[o].geometry.body;k=l[o].geometry.header;h=p.slice();if(isNaN(p[0])||isNaN(p[1])||isNaN(p[2])||isNaN(p[3])||p[2]===0||p[3]===0){continue}n=f._getRgbColor(l[o].color[f.options.colorOption]);l[o].computedColor=n;c.save();if(l[o].hasOwnProperty("children")&&k!==null){c.fillStyle=f.options.innerNodeHeaderGradient.call(f,c,k,n);c.fillRect(k[0],k[1],k[2],k[3]);if(l[o].hasOwnProperty("children")&&f.options.nodeBorderWidth===0){c.strokeStyle="#000";c.lineWidth=0.5;c.beginPath();c.moveTo(k[0]+k[2],k[1]);c.lineTo(k[0]+k[2],k[1]+k[3]);c.closePath();c.stroke()}h[0]=k[0];h[1]=k[1];h[3]=k[3]+p[3]}else{c.fillStyle=f.options.leafNodeBodyGradient.call(f,c,p,n);c.fillRect(p[0],p[1],p[2],p[3])}c.restore();for(m=0;m<h[3];m++){f._addRunlength(h[0],h[0]+h[2],(h[1]+m),l[o].id)}}if(l[o].hasOwnProperty("children")){b(l[o].children)}}};var f=this;var g=new Date();var d=f.element.find("canvas")[0];var c=d.getContext("2d");f._clearScanLines();b([f.options.nodeData]);var e=new Date();f.stats.renderLayoutMsec=(e-g)},_renderNodeLabels:function(){if(this.options.enableLabels!==true){return}var b=function(j){var m,h,k,l;for(l=0;l<j.length;l++){if(f._isRootNode(j[l])===false){m=j[l].geometry.body;h=j[l].geometry.header;if(isNaN(m[0])||isNaN(m[1])||isNaN(m[2])||isNaN(m[3])||m[2]===0||m[3]===0){continue}k=j[l].computedColor;c.save();c.beginPath();if(j[l].hasOwnProperty("children")){if(h!==null){f.options.innerNodeHeaderLabeller.call(f,c,h,k,j[l].id)}}else{f.options.leafNodeBodyLabeller.call(f,c,m,k,j[l].id)}c.restore()}if(j[l].hasOwnProperty("children")){b(j[l].children)}}};var f=this;var g=new Date();var d=f.element.find("canvas")[0];var c=d.getContext("2d");b([f.options.nodeData]);var e=new Date();f.stats.renderLabelsMsec=(e-g)},_refreshCanvas:function(){var b=this.element.find("canvas");if(b){b.remove()}b=document.createElement("canvas");b.setAttribute("width",this.options.dimensions[0]);b.setAttribute("height",this.options.dimensions[1]);var c=this;this.element.append(b).mousemove(function(n){var h=c.element.offset(),m=parseInt(h.left,10),l=parseInt(h.top,10),g=c.options.dimensions[0],o=c.options.dimensions[1],d,f,k,j;if(n.pageX<m+g&&n.pageY<(l+o)){d=c._coordsToId(n.pageX-m,n.pageY-l);f=[];for(j=0;j<d.length;j++){f.push(c._getNode([d[j]]))}k={nodes:f,ids:d};c._trigger("mousemove",n,k)}}).click(function(n){var h=c.element.offset(),m=parseInt(h.left,10),l=parseInt(h.top,10),g=c.options.dimensions[0],o=c.options.dimensions[1],d,f,k,j;if(n.pageX<m+g&&n.pageY<(l+o)){d=c._coordsToId(n.pageX-m,n.pageY-l);f=[];for(j=0;j<d.length;j++){f.push(c._getNode([d[j]]))}k={nodes:f,ids:d};c._trigger("click",n,k)}})},_refreshColorGradient:function(){var e=document.createElement("canvas"),d=this.options.colorStops,c,b,f;e.setAttribute("width",this.options.colorResolution);e.setAttribute("height",1);if(typeof(G_vmlCanvasManager)!=="undefined"){G_vmlCanvasManager.initElement(e)}c=e.getContext("2d");b=c.createLinearGradient(0,0,this.options.colorResolution,0);for(f=0;f<d.length;f+=1){b.addColorStop(d[f].val,d[f].color)}c.fillStyle=b;c.fillRect(0,0,this.options.colorResolution,1);this.options.colorGradientMap=c.getImageData(0,0,this.options.colorResolution,1)},_refreshLayout:function(){function b(n,k){var h=[],m,j,g,l;k.sort(function(i,o){if(i.size[e.options.sizeOption]>o.size[e.options.sizeOption]){return -1}if(i.size[e.options.sizeOption]<o.size[e.options.sizeOption]){return 1}return 0});for(l=0;l<k.length;l++){if(e._isRootNode(k[l])===true){h[l]=1}else{h[l]=k[l].size[e.options.sizeOption]}}g=e.options.layoutMethod([n[0],n[1],n[2],n[3]],h);for(l=0;l<k.length;l++){k[l].geometry={body:g[l],header:null};e._addNode2NodeList(k[l])}for(l=0;l<k.length;l++){if(k[l].hasOwnProperty("children")){m=k[l].geometry.body;j=k[l].geometry.header;if(e._isRootNode(k[l])===false&&(m[3]-e.options.innerNodeHeaderHeight>0)){j=k[l].geometry.header=m.slice();j[3]=e.options.innerNodeHeaderHeight;m[1]+=e.options.innerNodeHeaderHeight;m[3]-=e.options.innerNodeHeaderHeight}if(e._isRootNode(k[l])===false&&(m[2]-e.options.nodeBorderWidth>0)&&(m[3]-e.options.nodeBorderWidth>0)){if(e.options.dimensions[0]>m[0]+m[2]){m[2]-=e.options.nodeBorderWidth;if(j!==null){j[2]-=e.options.nodeBorderWidth}}if(e.options.dimensions[1]>m[1]+m[3]){m[3]-=e.options.nodeBorderWidth}}b(m,k[l].children)}}}var e=this;var f=new Date();var d=[0,0,e.options.dimensions[0],e.options.dimensions[1]];e._clearNodeList();b(d,[e.options.nodeData]);var c=new Date();e.stats.computeLayoutMsec=(c-f)},_getRgbColor:function(d){if(d===null){return TreemapUtils.hex2rgb(this.options.naColor)}var c=this.options.colorGradientMap.data;var b=Math.floor(d*(c.length/4))*4;return[c[b],c[b+1],c[b+2]]},_clearScanLines:function(){if(this.scanLines){this.scanLines.length=0;this.scanLines=[]}},_addRunlength:function(c,b,e,d){if(this.scanLines===undefined){this.scanLines=[]}y_str=parseInt(e,10);if(!this.scanLines[y_str]){this.scanLines[y_str]=[]}this.scanLines[y_str].push([c,b,d])},_coordsToId:function(h,g){var j,b,k,d,c,e,f;if(this.scanLines===undefined){return[]}j=this.scanLines[g];c=[];if(j){for(f=j.length-1;f>=0;f--){b=j[f];k=b[0];d=b[1];e=b[2];if(k<=h&&d>h){c.push(e)}}}return c},_clearNodeList:function(){if(this.nodeList){this.nodeList.length=0;this.nodeList=[]}},_addNode2NodeList:function(b){if(this.nodeList===undefined){this.nodeList=[]}if(!this.nodeList[b.id]){this.nodeList[b.id]=b}},_getNode:function(b){return this.nodeList[b]},_isRootNode:function(b){if(this.options.nodeData===b){return true}return false},destroy:function(){this.element.find("canvas").remove();a(window).unbind("resize");a.Widget.prototype.destroy.call(this)},stats:function(){return this.stats}})}(jQuery));String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.ltrim=function(){return this.replace(/^\s+/,"")};String.prototype.rtrim=function(){return this.replace(/\s+$/,"")};String.prototype.lpad=function(a,b){var c=this;while(c.length<b){c=a+c}return c};String.prototype.rpad=function(a,b){var c=this;while(c.length<b){c=c+a}return c};