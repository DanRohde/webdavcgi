(function(e){e.fn.MyPopup=function(t){function i(t,n){var i,s,o;r.contextmenuAnchorElement?(n=e(r.contextmenuAnchor),i=n.offset(),s=t.pageX-i.left+n.scrollLeft(),o=t.pageY-i.top+n.scrollTop()):(i=e(r.contextmenuAnchor).position(),s=t.pageX-i.left,o=t.pageY-i.top),r.contextmenu.css({top:o+"px",left:s+"px"})}function o(e){e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation()}function u(){return e("ul.popup:visible",n).hide(),n.data("MyPopup.contextmenu")&&n.data("MyPopup.contextmenu").hide().appendTo("body"),n}function a(t,n){return t.hasClass("disabled")?t:(e("ul.popup:first",t).toggle(n),e("ul.popup:first",t).is(":visible")||e("ul.popup",t).hide(),t)}function f(t){return window.clearTimeout(e("body").data(r.timername)),t}function l(t){return f(t),e("ul.popup:visible",t.siblings("li.popup")).hide(),t}var n=this;if(t==="close")return u();var r=e.extend({namespace:"popupnavigation",timername:"popupnavigationtimer",contextmenu:undefined,contextmenuTarget:undefined,contextmenuAnchor:undefined,contextmenuAnchorElement:!1,alloworigcontextmenu:!0,showEvent:undefined,autohide:!0},t);if(r.contextmenu){var s=r.contextmenu;n.data("MyPopup.contextmenu",s),r.contextmenuTarget.off("contextmenu."+r.namespace).on("contextmenu."+r.namespace,function(t){if(t.which==3){if(t.originalEvent.detail===2&&r.alloworigcontextmenu){u();return}r.alloworigcontextmenu||o(t),s.is(":visible")&&s.parent()[0]==e(this)[0]?u():(o(t),e(".MyPopup-autohide ul.popup:visible").hide(),e("ul.popup:visible",n).hide(),s.appendTo(e(this)).css({position:"absolute",opacity:1}).show(),i(t,e(this)),r.showEvent&&r.showEvent.call(this))}})}return n.filter(":not(.popup-click)").off("."+r.namespace).on("mouseenter."+r.namespace,function(){var t=e(this);f(t),e("body").data(r.timername,window.setTimeout(function(){a(l(t),!0)},350))}).on("click."+r.namespace,function(t){o(t),e("ul.popup:first:visible",e(".MyPopup-autohide").not(n)).hide();var r=e(this);a(l(f(r))),e(":focusable:first",r).focus()}).on("dblclick."+r.namespace,function(e){o(e)}).MyKeyboardEventHandler(),n.filter(".popup-click").off("."+r.namespace).on("click."+r.namespace,function(t){o(t),e("ul.popup:first:visible",e(".MyPopup-autohide").not(n)).hide(),a(l(e(this)))}).on("dblclick."+r.namespace,function(e){o(e)}).MyKeyboardEventHandler(),n.on("focus."+r.namespace,function(){l(e(this))}),n.siblings(":not(.popup)").off("."+r.namespace).on("focus."+r.namespace+" click."+r.namespace+" mouseenter."+r.namespace,function(){l(e(this))}),n.filter(".popup-click").siblings("li:not(.popup)").off("mouseenter."+r.namespace),r.autohide&&(n.addClass("MyPopup-autohide"),r.contextmenu&&r.contextmenu.addClass("MyPopup-autohide"),e("body").on("click."+r.namespace+" contextmenu."+r.namespace,function(t){e(t.target).closest(n).length!=1&&u()}).on("keydown."+r.namespace,function(e){e.keyCode==27&&u()})),n}})(jQuery);
