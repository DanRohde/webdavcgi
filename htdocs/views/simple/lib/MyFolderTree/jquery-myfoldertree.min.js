(function(e){e.fn.MyFolderTree=function(t,n,r){function l(t){return t.find(".mft-node-label").off(".mft").on("click.mft",function(){var t=e(this).closest(".mft-node"),n=t.data("mftn");t.data("mft-clicktimeout",window.setTimeout(function(){if(!t.data("mft-clicktimeout"))return;t.removeData("mft-clicktimeout"),s.nodeClickHandler(n),s.readOnFolderClick&&h(t,n,!0),i.find(".mft-active-node").removeClass("mft-active-node"),t.addClass("mft-active-node").children(".mft-node-label:first").addClass("mft-active-node")},300))}).on("dblclick.mft",function(t){var n=e(this).closest(".mft-node"),r=n.data("mftn");window.clearTimeout(n.data("mft-clicktimeout")),n.removeData("mft-clicktimeout"),h(n,r),p(n);if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var i=window.getSelection();i&&i.removeAllRanges&&i.removeAllRanges()}}),t.find(".mft-node-expander").off(".mft").on("click.mft",function(t){var n=e(this),r=n.closest(".mft-node"),i=r.data("mftn");h(r,i,!1),p(r)}).on("dblclick.mft",function(t){if(!s.rereadOnDblClick)return;c(e(this).closest(".mft-node"))}),s.droppable&&(s.droppable.params.over_orig=s.droppable.params.over,s.droppable.params.over=function(t,n){if(t.target!=this)return;var r=e(this).closest(".mft-node");i.data("mft-drop-timeout",window.setTimeout(function(){h(r,r.data("mftn")),p(r,!1)},2e3)),s.droppable.params.over_orig&&s.droppable.params.over_orig.call(this,t,n)},s.droppable.params.out_orig=s.droppable.params.out,s.droppable.params.out=function(e,t){window.clearTimeout(i.data("mft-drop-timeout")),s.droppable.params.out_orig&&s.droppable.params.out_orig.call(this,e,t)},t.find(s.droppable.selector).droppable(s.droppable.params)),t.find(".mft-node-expander,.mft-node-label").off("keydown.mft").on("keydown.mft",g),s.initDom(t),t}function c(e){var t=e.data("mftn");t.read=!1,e.children(".mft-list").remove(),t.children=[],h(e,t,!0,!0),p(e,!1)}function h(e,t,n,r){if(t.read)return;t.read=!0,s.getFolderTree(t,function(t){l(e.append(v(t))),e.addClass("mft-node-read").toggleClass("mft-node-empty",t.length==0),(n||s.autoExpandOnRead)&&p(e,!1)},r)}function p(t,n){t.toggleClass("mft-collapsed",n),t.hasClass("mft-collapsed")||e(".mft-node",t).addClass("mft-collapsed"),e(".mft-node-expander",t).attr({"aria-expanded":!t.hasClass("mft-collapsed")})}function d(t){t.ext_attributes||(t.ext_attributes="");var n=e("<li "+t.ext_attributes+"></li>").addClass("mft-node"),r=e("<div/>").addClass("mft-node-expander").attr({tabindex:0,role:"tree","aria-label":t.name+" expander","aria-expanded":!t.expand}).appendTo(n),i=e("<div/>").addClass("mft-node-label").addClass(t.labelclasses).appendTo(n).attr({tabindex:0,"aria-label":t.name,role:"treeitem"}),s=e("<div/>").addClass("mft-node-icon").addClass(t.iconclasses).appendTo(i),o=e("<div/>").addClass("mft-node-label-text").text(t.name).appendTo(i);return t.read=="yes"&&n.addClass("mft-node-read"),t.classes&&n.addClass(t.classes),t.ext_classes&&n.addClass(t.ext_classes),t.expand||n.addClass("mft-collapsed"),t.title&&i.attr("title",t.title),t.help&&n.attr("title",t.help),t.attr&&n.attr(t.attr),t.labelAttr&&i.attr(t.labelAttr),t.expanderAttr&&r.attr(t.expanderAttr),n.data("mftn",t),t.children?n.toggleClass("mft-node-empty",t.read=="yes"&&t.children.length==0).append(v(t.children)):n.toggleClass("mft-node-empty",t.read=="yes"),n}function v(t){var n=e("<ul/>").addClass("mft-list");t.sort(function(e,t){return e.name.localeCompare?e.name.localeCompare(t.name):e.name<t.name?-1:e.name>t.name?1:0}),n.data("mft",t);for(var r=0;r<t.length;r++)n.append(d(t[r]));return n}function m(t){return i.find(".mft-node").filter(function(n,r){var i=e(r);return t(i,i.data("mftn"))})}function g(t){function s(){n.parent().prev().find(r+":focusable:last").focus().length==0&&n.parents(".mft-list:first").parents(".mft-node:first").find(r+":focusable:first").focus()}function o(){if(n.parent().find(".mft-list:first").find(r+":focusable:first").focus().length==0&&n.parent().next().find(r+":focusable:first").focus().length==0){var e=n.parents(".mft-list:first").parents(".mft-node:first");while(e.next().length==0&&e.parents(".mft-list:first").parents(".mft-node:first").length>0)e=e.parents(".mft-list:first").parents(".mft-node:first");e.next().find(r+":focusable:first").focus()}}if(t.target!=this)return;var n=e(this),r=n.hasClass("mft-node-label")?".mft-node-label":".mft-node-expander";switch(t.keyCode){case 32:case 13:if(n.data("input-finished")){n.removeData("input-finished");return}n.trigger("click",{origEvent:t});break;case 33:n.parent().siblings().first().find(r+":focusable:first").focus();break;case 34:n.parent().siblings().last().find(r+":focusable:last").focus();break;case 35:i.find(r+":focusable:last").focus();break;case 36:i.find(r+":focusable:first").focus();break;case 37:n.prevAll(":focusable:first").focus().length==0&&(r=".mft-node-label",s());break;case 38:s(n);break;case 39:n.nextAll(":focusable:first").focus().length==0&&(r=".mft-node-expander",o());break;case 40:o()}}var i=this,s;if(typeof t=="string"){s=i.data("myfoldertree-settings");if(t=="set-active-node"){i.find(".mft-active-node").removeClass("mft-active-node");var o=m(n).addClass("mft-active-node");o.children(".mft-node-label:first").addClass("mft-active-node"),o.parents(".mft-collapsed").removeClass("mft-collapsed"),o.length>0&&o[0].scrollIntoView&&o[0].scrollIntoView()}else{if(t=="get-active-node")return i.find(".mft-active-node");if(t=="add-node-data"){var o=m(n);o.length>0&&h(o,o.data("mftn"),!1)}else{if(t=="get-node-data")return n.closest(".mft-node").data("mftn");if(t=="get-nodes")return m(n);if(t=="remove-node"){var o=m(n),u=o.parents(".mft-node:first");o.remove(),u.toggleClass("mft-node-empty",u.find(".mft-node").length==0)}else{if(t=="is-node-read")return n.closest(".mft-node").data("mftn").read;if(t=="is-node")return n.closest(".mft-node").length>0;if(t=="get-node-by-element")return n.closest(".mft-node");if(t=="get-root-node")return i.find(".mft-node:first");if(t=="set-node-unread"
){var o=m(n),a=o.data("mftn");o.removeClass("mft-node-read mft-node-empty").addClass("mft-collapsed").find(".mft-list").remove(),delete a.children,delete a.read}else t=="collapse-all-nodes"?n.closest(".mft-node").addClass("mft-collapsed").find(".mft-node").addClass("mft-collapsed"):t=="expand-all-nodes"?(h(n,n.data("mftn"),!1),n.closest(".mft-node").removeClass("mft-collapsed").find(".mft-node.mft-node-read").removeClass("mft-collapsed")):t=="expand-node"?h(n,n.data("mftn"),!0):t=="reload-node"&&c(n.closest(".mft-node"))}}}return i}s=e.extend({},e.fn.MyFolderTree.defaults,t),i.data("myfoldertree-settings",s);var f=l(v(s.rootNodes));return i.addClass("mft-foldertree").append(f),this},e.fn.MyFolderTree.defaults={rootNodes:[{name:"/",read:!0,expand:!0,children:[{name:"test1",title:"/test1/"},{name:"test2"}]}],readOnFolderClick:!1,autoExpandOnRead:!1,rereadOnDblClick:!0,getFolderTree:function(e,t){e.children=[];for(var n=0;n<3;n++)e.children.push({name:e.name+"."+n});return t(e.children),e},nodeClickHandler:function(e){return e},initDom:function(e){return e}}})(jQuery);
