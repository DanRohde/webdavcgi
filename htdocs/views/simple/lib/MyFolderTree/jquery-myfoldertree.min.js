(function(a){a.fn.MyFolderTree=function(p,d,j){var i=this;var e;if(typeof p=="string"){e=i.data("myfoldertree-settings");if(p=="set-active-node"){i.find(".mft-active-node").removeClass("mft-active-node");var k=i.find(".mft-node").filter(function(q,s){var r=a(s);return d(r,r.data("mftn"))}).addClass("mft-active-node");k.children(".mft-node-label:first").addClass("mft-active-node");k.parents(".mft-collapsed").removeClass("mft-collapsed");if(k.length>0&&k[0].scrollIntoView){k[0].scrollIntoView()}}else{if(p=="add-node-data"){var k=i.find(".mft-node").filter(function(q,s){var r=a(s);return d(r,r.data("mftn"))});if(k.length>0){f(k,k.data("mftn"),false)}}else{if(p=="get-node-data"){return d.closest(".mft-node").data("mftn")}else{if(p=="remove-node"){var k=i.find(".mft-node").filter(function(q,s){var r=a(s);return d(r,r.data("mftn"))});var l=k.parents(".mft-node:first");k.remove();l.toggleClass("mft-node-empty",l.find(".mft-node").length==0)}else{if(p=="set-node-unread"){var k=i.find(".mft-node").filter(function(q,s){var r=a(s);return d(r,r.data("mftn"))});var g=k.data("mftn");k.removeClass("mft-node-read mft-node-empty").addClass("mft-collapsed").find(".mft-list").remove();delete g.children;delete g.read}else{if(p=="collapse-all-nodes"){d.closest(".mft-node").addClass("mft-collapsed").find(".mft-node").addClass("mft-collapsed")}else{if(p=="expand-all-nodes"){f(d,d.data("mftn"),false);d.closest(".mft-node").removeClass("mft-collapsed").find(".mft-node.mft-node-read").removeClass("mft-collapsed")}else{if(p=="expand-node"){f(d,d.data("mftn"),true)}else{if(p=="reload-node"){b(d.closest(".mft-node"))}}}}}}}}}return i}e=a.extend({},a.fn.MyFolderTree.defaults,p);i.data("myfoldertree-settings",e);var h=m(c(e.rootNodes));i.addClass("mft-foldertree").append(h);function m(q){q.find(".mft-node-label").off(".mft").on("click.mft",function(){var r=a(this).closest(".mft-node");var s=r.data("mftn");r.data("mft-clicktimeout",window.setTimeout(function(){if(!r.data("mft-clicktimeout")){return}else{r.removeData("mft-clicktimeout")}e.nodeClickHandler(s);if(e.readOnFolderClick){f(r,s,true)}i.find(".mft-active-node").removeClass("mft-active-node");r.addClass("mft-active-node").children(".mft-node-label:first").addClass("mft-active-node")},300))}).on("dblclick.mft",function(s){var r=a(this).closest(".mft-node");var u=r.data("mftn");window.clearTimeout(r.data("mft-clicktimeout"));r.removeData("mft-clicktimeout");f(r,u);o(r);if(document.selection&&document.selection.empty){document.selection.empty()}else{if(window.getSelection){var t=window.getSelection();if(t&&t.removeAllRanges){t.removeAllRanges()}}}});q.find(".mft-node-expander").off(".mft").on("click.mft",function(t){var r=a(this);var s=r.closest(".mft-node");var u=s.data("mftn");f(s,u,false);o(s)}).on("dblclick.mft",function(r){if(!e.rereadOnDblClick){return}b(a(this).closest(".mft-node"))});if(e.droppable){e.droppable.params.over_orig=e.droppable.params.over;e.droppable.params.over=function(s,t){if(s.target!=this){return}var r=a(this).closest(".mft-node");i.data("mft-drop-timeout",window.setTimeout(function(){f(r,r.data("mftn"));o(r,false)},2000));if(e.droppable.params.over_orig){e.droppable.params.over_orig.call(this,s,t)}};e.droppable.params.out_orig=e.droppable.params.out;e.droppable.params.out=function(r,s){window.clearTimeout(i.data("mft-drop-timeout"));if(e.droppable.params.out_orig){e.droppable.params.out_orig.call(this,r,s)}};q.find(e.droppable.selector).droppable(e.droppable.params)}e.initDom(q);return q}function b(q){var r=q.data("mftn");r.read=false;q.children(".mft-list").remove();r.children=[];f(q,r,true,true);o(q,false)}function f(r,s,q,t){if(s.read){return}s.read=true;e.getFolderTree(s,function(u){m(r.append(c(u)));r.addClass("mft-node-read").toggleClass("mft-node-empty",u.length==0);if(q||e.autoExpandOnRead){o(r,false)}},t)}function o(q,r){q.toggleClass("mft-collapsed",r);if(!q.hasClass("mft-collapsed")){a(".mft-node",q).addClass("mft-collapsed")}}function n(s){var q=a("<li/>").addClass("mft-node");var r=a("<div/>").addClass("mft-node-label").text(s.name).attr("tabindex",0);q.append(a("<div/>").addClass("mft-node-expander").attr("tabindex",0)).append(r);if(s.read=="yes"){q.addClass("mft-node-read")}if(s.classes){q.addClass(s.classes)}if(!s.expand){q.addClass("mft-collapsed")}if(s.title){r.attr("title",s.title)}if(s.help){q.attr("title",s.help)}q.data("mftn",s);if(s.children){q.toggleClass("mft-node-empty",s.read=="yes"&&s.children.length==0).append(c(s.children))}else{q.toggleClass("mft-node-empty",s.read=="yes")}return q}function c(q){var r=a("<ul/>").addClass("mft-list");q.sort(function(u,t){return u.name.localeCompare?u.name.localeCompare(t.name):u.name<t.name?-1:u.name>t.name?1:0});r.data("mft",q);for(var s=0;s<q.length;s++){r.append(n(q[s]))}return r}return this};a.fn.MyFolderTree.defaults={rootNodes:[{name:"/",read:true,expand:true,children:[{name:"test1",title:"/test1/"},{name:"test2"}]}],readOnFolderClick:false,autoExpandOnRead:false,rereadOnDblClick:true,getFolderTree:function(c,d){c.children=[];for(var b=0;b<3;b++){c.children.push({name:c.name+"."+b})}d(c.children);return c},nodeClickHandler:function(b){return b},initDom:function(b){return b}}}(jQuery));