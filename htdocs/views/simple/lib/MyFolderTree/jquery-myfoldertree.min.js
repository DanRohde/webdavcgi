(function(a){a.fn.MyFolderTree=function(q,d,k){var j=this;var e;if(typeof q=="string"){e=j.data("myfoldertree-settings");if(q=="set-active-node"){j.find(".mft-active-node").removeClass("mft-active-node");var l=h(d).addClass("mft-active-node");l.children(".mft-node-label:first").addClass("mft-active-node");l.parents(".mft-collapsed").removeClass("mft-collapsed");if(l.length>0&&l[0].scrollIntoView){l[0].scrollIntoView()}}else{if(q=="add-node-data"){var l=h(d);if(l.length>0){f(l,l.data("mftn"),false)}}else{if(q=="get-node-data"){return d.closest(".mft-node").data("mftn")}else{if(q=="get-nodes"){return h(d)}else{if(q=="remove-node"){var l=h(d);var m=l.parents(".mft-node:first");l.remove();m.toggleClass("mft-node-empty",m.find(".mft-node").length==0)}else{if(q=="set-node-unread"){var l=h(d);var g=l.data("mftn");l.removeClass("mft-node-read mft-node-empty").addClass("mft-collapsed").find(".mft-list").remove();delete g.children;delete g.read}else{if(q=="collapse-all-nodes"){d.closest(".mft-node").addClass("mft-collapsed").find(".mft-node").addClass("mft-collapsed")}else{if(q=="expand-all-nodes"){f(d,d.data("mftn"),false);d.closest(".mft-node").removeClass("mft-collapsed").find(".mft-node.mft-node-read").removeClass("mft-collapsed")}else{if(q=="expand-node"){f(d,d.data("mftn"),true)}else{if(q=="reload-node"){b(d.closest(".mft-node"))}}}}}}}}}}return j}e=a.extend({},a.fn.MyFolderTree.defaults,q);j.data("myfoldertree-settings",e);var i=n(c(e.rootNodes));j.addClass("mft-foldertree").append(i);function n(r){r.find(".mft-node-label").off(".mft").on("click.mft",function(){var s=a(this).closest(".mft-node");var t=s.data("mftn");s.data("mft-clicktimeout",window.setTimeout(function(){if(!s.data("mft-clicktimeout")){return}else{s.removeData("mft-clicktimeout")}e.nodeClickHandler(t);if(e.readOnFolderClick){f(s,t,true)}j.find(".mft-active-node").removeClass("mft-active-node");s.addClass("mft-active-node").children(".mft-node-label:first").addClass("mft-active-node")},300))}).on("dblclick.mft",function(t){var s=a(this).closest(".mft-node");var v=s.data("mftn");window.clearTimeout(s.data("mft-clicktimeout"));s.removeData("mft-clicktimeout");f(s,v);p(s);if(document.selection&&document.selection.empty){document.selection.empty()}else{if(window.getSelection){var u=window.getSelection();if(u&&u.removeAllRanges){u.removeAllRanges()}}}});r.find(".mft-node-expander").off(".mft").on("click.mft",function(u){var s=a(this);var t=s.closest(".mft-node");var v=t.data("mftn");f(t,v,false);p(t)}).on("dblclick.mft",function(s){if(!e.rereadOnDblClick){return}b(a(this).closest(".mft-node"))});if(e.droppable){e.droppable.params.over_orig=e.droppable.params.over;e.droppable.params.over=function(t,u){if(t.target!=this){return}var s=a(this).closest(".mft-node");j.data("mft-drop-timeout",window.setTimeout(function(){f(s,s.data("mftn"));p(s,false)},2000));if(e.droppable.params.over_orig){e.droppable.params.over_orig.call(this,t,u)}};e.droppable.params.out_orig=e.droppable.params.out;e.droppable.params.out=function(s,t){window.clearTimeout(j.data("mft-drop-timeout"));if(e.droppable.params.out_orig){e.droppable.params.out_orig.call(this,s,t)}};r.find(e.droppable.selector).droppable(e.droppable.params)}e.initDom(r);return r}function b(r){var s=r.data("mftn");s.read=false;r.children(".mft-list").remove();s.children=[];f(r,s,true,true);p(r,false)}function f(s,t,r,u){if(t.read){return}t.read=true;e.getFolderTree(t,function(v){n(s.append(c(v)));s.addClass("mft-node-read").toggleClass("mft-node-empty",v.length==0);if(r||e.autoExpandOnRead){p(s,false)}},u)}function p(r,s){r.toggleClass("mft-collapsed",s);if(!r.hasClass("mft-collapsed")){a(".mft-node",r).addClass("mft-collapsed")}}function o(u){if(!u.ext_attributes){u.ext_attributes=""}var r=a("<li "+u.ext_attributes+"></li>").addClass("mft-node");var w=a("<div/>").addClass("mft-node-expander").attr("tabindex",0).appendTo(r);var s=a("<div/>").addClass("mft-node-label").addClass(u.labelclasses).appendTo(r).attr("tabindex",0);var t=a("<div/>").addClass("mft-node-icon").addClass(u.iconclasses).appendTo(s);var v=a("<div/>").addClass("mft-node-label-text").text(u.name).appendTo(s);if(u.read=="yes"){r.addClass("mft-node-read")}if(u.classes){r.addClass(u.classes)}if(u.ext_classes){r.addClass(u.ext_classes)}if(!u.expand){r.addClass("mft-collapsed")}if(u.title){s.attr("title",u.title)}if(u.help){r.attr("title",u.help)}r.data("mftn",u);if(u.children){r.toggleClass("mft-node-empty",u.read=="yes"&&u.children.length==0).append(c(u.children))}else{r.toggleClass("mft-node-empty",u.read=="yes")}return r}function c(r){var s=a("<ul/>").addClass("mft-list");r.sort(function(v,u){return v.name.localeCompare?v.name.localeCompare(u.name):v.name<u.name?-1:v.name>u.name?1:0});s.data("mft",r);for(var t=0;t<r.length;t++){s.append(o(r[t]))}return s}function h(r){return j.find(".mft-node").filter(function(s,u){var t=a(u);return r(t,t.data("mftn"))})}return this};a.fn.MyFolderTree.defaults={rootNodes:[{name:"/",read:true,expand:true,children:[{name:"test1",title:"/test1/"},{name:"test2"}]}],readOnFolderClick:false,autoExpandOnRead:false,rereadOnDblClick:true,getFolderTree:function(c,d){c.children=[];for(var b=0;b<3;b++){c.children.push({name:c.name+"."+b})}d(c.children);return c},nodeClickHandler:function(b){return b},initDom:function(b){return b}}}(jQuery));